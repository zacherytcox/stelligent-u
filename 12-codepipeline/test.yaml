AWSTemplateFormatVersion: '2010-09-09'
Parameters:
  VPCID:
    Type: String
  SubnetID:
    Type: String
  TagUser:
    Type: String
  TagLesson:
    Type: String
  TagLab:
    Type: String
  KeyName:
    Type: String
Resources:
  Bucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Ref TagUser
    DeletionPolicy: Delete
  CodePipeline:
    Type: AWS::CodePipeline::Pipeline
    Properties: 
      ArtifactStore: 
        Location: !Ref Bucket
        Type: S3
      RoleArn: !GetAtt IAMRole.Arn
      Stages: 
        - Name: Source
          Actions: 
            - Name: Source
              ActionTypeId: 
                Category: Source
                Owner: AWS
                Provider: CodeStarSourceConnection
                Version: 1
              Configuration:
                ConnectionArn: !Ref CodeStarConnection
                FullRepositoryId: zacherytcox/stelligent-u
                BranchName: 'Lab-12'
              OutputArtifacts: 
                - Name: SourceOutput
        - Name: Build
          Actions: 
            - Name: Build
              ActionTypeId: 
                Category: Build
                Owner: AWS
                Provider: CodeBuild
                Version: 1
              InputArtifacts: 
                - Name: SourceOutput
              Configuration:
                ProjectName: "zachtestbuild"
        - Name: Deploy
          Actions: 
            - Name: Deploy
              ActionTypeId: 
                Category: Deploy
                Owner: AWS
                Provider: CloudFormation
                Version: 1
              Configuration: 
                ActionMode: "CREATE_UPDATE"
                StackName: "zachtestcodepipeline"
                RoleArn: !GetAtt IAMRole.Arn
                TemplatePath: SourceOutput::12-codepipeline/bucket.yaml
                ParameterOverrides: | 
                  {"BucketNameParameter": "zachtestcodepipelines3bucket"}
              InputArtifacts: 
                - Name: SourceOutput
        # - Name: Test
        #   Actions: 
        #     - Name: Test
        #       ActionTypeId: 
        #         Category: Test
        #         Owner: AWS
        #         Provider: CodeBuild
        #         Version: 1
              # Configuration:
              #   ConnectionArn: !Ref CodeStarConnection
              #   FullRepositoryId: zacherytcox/stelligent-u
              #   BranchName: 'Lab-12'
              # OutputArtifacts: 
              #   - Name: SourceOutput
      Tags:  
        - Key: user
          Value: !Ref TagUser
        - Key: stelligent-u-lesson
          Value: !Ref TagLesson
        - Key: stelligent-u-lab
          Value: !Ref TagLab
  CodeStarConnection:
    Type: AWS::CodeStarConnections::Connection
    Properties: 
      ConnectionName: !Ref TagUser
      ProviderType: GitHub
      Tags:   
        - Key: user
          Value: !Ref TagUser
        - Key: stelligent-u-lesson
          Value: !Ref TagLesson
        - Key: stelligent-u-lab
          Value: !Ref TagLab
  IAMRole:
    Type: AWS::IAM::Role
    Properties: 
      AssumeRolePolicyDocument: 
        Version: '2012-10-17'
        Statement:
        - Sid: ''
          Effect: Allow
          Principal:
            Service: 
              - codepipeline.amazonaws.com
              - codebuild.amazonaws.com
              - cloudformation.amazonaws.com
          Action: sts:AssumeRole
      Description: String
      Policies: 
        - PolicyDocument: 
            Version: '2012-10-17'
            Statement:
            - Sid: AWSCloudTrailCreateLogStream20141101
              Effect: Allow
              Action:
              - '*'
              Resource:
              - '*'
          PolicyName: Policy
      Tags: 
        - Key: user
          Value: !Ref TagUser
        - Key: stelligent-u-lesson
          Value: !Ref TagLesson
        - Key: stelligent-u-lab
          Value: !Ref TagLab
  CodeBuild:
    Type: AWS::CodeBuild::Project
    Properties: 
      Artifacts: 
        Type: CODEPIPELINE
      Environment: 
        ComputeType: BUILD_GENERAL1_SMALL
        Image: al2/standard/3.0
        Type: LINUX_CONTAINER
      ServiceRole: !GetAtt IAMRole.Arn
      Source: 
        Type: CODEPIPELINE
      Tags: 
        - Key: user
          Value: !Ref TagUser
        - Key: stelligent-u-lesson
          Value: !Ref TagLesson
        - Key: stelligent-u-lab
          Value: !Ref TagLab
